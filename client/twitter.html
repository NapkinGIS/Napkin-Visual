<!--
/*©agpl*************************************************************************
*                                                                              *
* Napkin Visual – Visualisation platform for the Napkin platform               *
* Copyright (C) 2020  Napkin AS                                                *
*                                                                              *
* This program is free software: you can redistribute it and/or modify         *
* it under the terms of the GNU Affero General Public License as published by  *
* the Free Software Foundation, either version 3 of the License, or            *
* (at your option) any later version.                                          *
*                                                                              *
* This program is distributed in the hope that it will be useful,              *
* but WITHOUT ANY WARRANTY; without even the implied warranty of               *
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the                 *
* GNU Affero General Public License for more details.                          *
*                                                                              *
* You should have received a copy of the GNU Affero General Public License     *
* along with this program. If not, see <http://www.gnu.org/licenses/>.         *
*                                                                              *
*****************************************************************************©*/
-->


<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="x-ua-compatible" content="ie=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

		<title>Napkin Visual – Twitter data</title>

		<link rel="icon" href="assets/logo.svg" />

		<!-- Uber Font -->
		<link rel="stylesheet" href="lib/superfine.css" />

		<!-- MapBox css -->
		<link href="lib/mapbox-gl.css" rel="stylesheet" />

		<!-- Load React/Redux -->
		<script type="text/javascript" src="lib/react.production.min.js"></script>
		<script type="text/javascript" src="lib/react-dom.production.min.js"></script>
		<script type="text/javascript" src="lib/redux.js"></script>
		<script type="text/javascript" src="lib/react-redux.min.js"></script>
		<script type="text/javascript" src="lib/styled-components.min.js"></script>

		<!-- Load build -->
		<script type="text/javascript" src="lib/build.min.js"></script>

		<style type="text/css">
			body {
				margin: 0; padding: 0; overflow: hidden;
			}
		</style>
	</head>
	<body>

		<div id="app"></div>

		<!-- Load map component -->
		<script type="text/javascript">
			"use strict";

			function makeid(l) {
				let c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789', r = '';

				for(let i = 0; i < l; i++) {
					r += c.charAt(Math.floor(Math.random() * c.length));
				}

				return r;
			}


			/* MapBox token */
			const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5kcmVhc2F0YWthbiIsImEiOiJjazlndzM1cmUwMnl5M21tZjQ3dXpzeHJnIn0.oE5zp040ZzJj5QgCDznweg';

			/** STORE **/
			const reducers = (function createReducers(redux, keplerGl) {
				return redux.combineReducers({
					keplerGl: keplerGl.keplerGlReducer.initialState({
						mapState: {
							latitude: 12,
							longitude: -16,
							zoom: 1.5597427909659196
						},
						mapStyle: {
							styleType: 'satellite',
							threeDBuildingColor: [ 192, 192, 192 ]
						},
						uiState: {
							currentModal: null,
							activeSidePanel: false,
							readOnly: false
						}
					})
				});
			}(Redux, KeplerGl));

			const middleWares = (function createMiddlewares(keplerGl) {
				return keplerGl.enhanceReduxMiddleware([
					// Add other middlewares here
				]);
			}(KeplerGl));

			const enhancers = (function craeteEnhancers(redux, middles) {
				return redux.applyMiddleware(...middles);
			}(Redux, middleWares));

			const store = (function createStore(redux, enhancers) {
				const initialState = {};

				return redux.createStore(
					reducers,
					initialState,
					redux.compose(enhancers)
				);
			}(Redux, enhancers));
			/** END STORE **/

			/** COMPONENTS **/
			const KeplerElement = (function(react, keplerGl, mapboxToken) {
				return function(props) {
					let rootElm = react.useRef(null);

					let _useState = react.useState({
						width: window.innerWidth,
						height: window.innerHeight
					});

					let windowDimension = _useState[0],
						setDimension = _useState[1];

					react.useEffect(function sideEffect() {
						function handleResize() {
							setDimension({ width: window.innerWidth, height: window.innerHeight });
						};
						window.addEventListener('resize', handleResize);
						return function() { window.removeEventListener('resize', handleResize); };
					}, []);

					return react.createElement(
						'div',
						{ style: { position: 'absolute', left: 0, width: '100vw', height: '100vh' } },
						react.createElement(keplerGl.KeplerGl, {
							mapboxApiAccessToken: mapboxToken,
							id: 'map',
							width: windowDimension.width,
							height: windowDimension.height,
							appName: 'Napkin Visual',
							appWebsite: 'https://napkingis.no'
						})
					);
				};
			}(React, KeplerGl, MAPBOX_TOKEN));

			const app = (function createReactReduxProvider(react, reactRedux, KeplerElement) {
				return react.createElement(
					reactRedux.Provider,
					{ store },
					react.createElement(KeplerElement, null)
				)
			}(React, ReactRedux, KeplerElement));
			/** END COMPONENTS **/

			/** Render **/
			(function render(react, reactDOM, app) {
				reactDOM.render(app, document.getElementById('app'));
			}(React, ReactDOM, app));


			(function customize(keplerGl, store) {
				//store.dispatch(keplerGl.toggleSplitMap());
				//let exportMapData = function() { return KeplerGl.KeplerGlSchema.save(store.getState().keplerGl.map); };

				const dataId = makeid(8);
				const datasets = [
					{
						"version": "v1",
						"data": {
							"id": dataId,
							"label": "twitter.csv",
							"color": [ 143, 47, 191 ],
							"allData": [],
							"fields": [
								{ "name": "lat",			"type": "real",		"format": "",				"analyzerType":"FLOAT" },
								{ "name": "lon",			"type": "real",		"format": "",				"analyzerType":"FLOAT" },
								//{ "name": "username",		"type": "string",	"format": "",				"analyzerType":"STRING" },
								//{ "name": "text",			"type": "string",	"format": "",				"analyzerType":"STRING" },
								{ "name": "trend",			"type": "string",	"format": "",				"analyzerType":"STRING" },
								{ "name": "source",			"type": "string",	"format": "",				"analyzerType":"STRING" },
								//{ "name": "link",			"type": "string",	"format": "",				"analyzerType":"STRING" },
								{ "name": "timestamp",		"type": "timestamp","format": "YYYY-M-D H:m:s",	"analyzerType":"DATETIME" },
								//{ "name": "retweets",		"type": "integer",	"format": "",				"analyzerType":"INT" },
								//{ "name": "replies",		"type": "integer",	"format": "",				"analyzerType":"INT" },
								//{ "name": "likes",			"type": "integer",	"format": "",				"analyzerType":"INT" },
								//{ "name": "quotes",			"type": "integer",	"format": "",				"analyzerType":"INT" },
								//{ "name": "id",				"type": "string",	"format": "",				"analyzerType":"STRING" },
								//{ "name": "conversation_id","type": "string",	"format": "",				"analyzerType":"STRING" },
								//{ "name": "author_id",		"type": "string",	"format": "",				"analyzerType":"STRING" },
								{ "name": "count",			"type": "integer",	"format": "",				"analyzerType":"INT" }
							]
						}
					}
				];

				//const layerId = makeid(6);
				const config = {
					"version": "v1",
					"config": {
						"visState": {
							"filters": [],
							"layers": [
								{
									"id": "cO7POIFy",
									"type": "point",
									"config": {
										"dataId": dataId,
										"label": "Tweets",
										"color": [255,203,153],
										"columns": {
											"lat": "lat",
											"lng": "lon",
											"altitude": null
										},
										"isVisible": true,
										"visConfig": {
											"radius": 15,
											"fixedRadius": false,
											"opacity": 1,
											"outline": true,
											"thickness": 1,
											"strokeColor": [25,20,16],
											"colorRange": {
												"name": "Ice And Fire",
												"type": "diverging",
												"category": "Uber",
												"colors": ["#0198BD","#49E3CE","#E8FEB5","#FEEDB1","#FEAD54","#D50255"]
											},
											"strokeColorRange": {
												"name": "Global Warming",
												"type": "sequential",
												"category": "Uber",
												"colors": ["#5A1846","#900C3F","#C70039","#E3611C","#F1920E","#FFC300"]
											},
											"radiusRange": [0,50],
											"filled": true
										},
										"hidden": false,
										"textLabel": [
											{
												"field": null,
												"color": [255,255,255],
												"size": 18,
												"offset": [0,0],
												"anchor": "start",
												"alignment": "center"
											}
										]
									},
									"visualChannels": {
										"colorField": { "name":"trend", "type":"string" },
										"colorScale": "ordinal",
										"strokeColorField": null,
										"strokeColorScale": "quantile",
										"sizeField": null,
										"sizeScale": "linear"
									}
								}
							],
							"interactionConfig": {
								"tooltip": {
									"fieldsToShow": {
										"cO7POIFy": [
											//{ "name": "username", "format": null },
											//{ "name": "text", "format": null },
											{ "name": "trend", "format": null },
											{ "name": "source", "format": null },
											//{ "name": "link", "format": null },
											{ "name": "timestamp", "format": null }
										]
									},
									"compareMode": false,
									"compareType": "absolute",
									"enabled": true
								},
								"brush": { "size": 0.5, "enabled": false },
								"geocoder": { "enabled": true },
								"coordinate": { "enabled":false }
							},
							"layerBlending": "normal",
							"splitMaps": [],
							"animationConfig": { "currentTime": null, "speed": 1 }
						},
						/*"mapState": {
							"bearing": 0,
							"dragRotate": false,
							"latitude": 12,
							"longitude": -16,
							"pitch": 0,
							"zoom": 1.5597427909659196,
							"isSplit": false
						},*/
						/*"mapStyle": {
							"styleType": "satellite",
							"topLayerGroups": {},
							"visibleLayerGroups": {},
							"threeDBuildingColor": [ 3.7245996603793508, 6.518049405663864, 13.036098811327728 ],
							"mapStyles": {}
						}*/
					}
				};


				function load() {
					fetch("http://localhost:3000/twitter")
					.then(res => res.json())
					.then(res => {
						let collision = false;
						for(let r of res) {
							for(let d of datasets[0].data.allData) {
								if(r[12] == d[12]) {
									collision = true;
									break;
								}
							}

							if(!collision) datasets[0].data.allData.push(r);
							collision = false;
						}

						let data = datasets[0].data.allData;
						for(let i = 0; i < data.length; i++) {
							if(data[i][15] > 3)
								datasets[0].data.allData.splice(i, 1);
							else
								datasets[0].data.allData[i][15] += 1;
						}

						const loadedData = keplerGl.KeplerGlSchema.load(
							datasets,
							config
						);

						store.dispatch(keplerGl.addDataToMap({
							datasets: loadedData.datasets,
							config: loadedData.config,
							options: {
								centerMap: false
							}
						}));

						setTimeout(load, 4000);
					});
				}
				load();


				// TODO: use the above data-import and fetch call to cook up a dynamic-data example using, for example, finantial data, social-media data or GitHub pull/clone data

			}(KeplerGl, store));
		</script>
	</body>
</html>
